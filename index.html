<html>
  <head>
    <title>Zabbix monitor</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
  </head>
  <body>

  <script type="text/javascript">
    var gui = require('nw.gui');
    var win = gui.Window.get();
    var zabbix = require('./lib/zabbix.js');
    var secretsProvider = require('./lib/secrets.js');
    var secrets = secretsProvider.loadSecrets();
    var storage = require('./lib/storage.js').storage;
    var triggerFilter = storage.getJSONItem('triggerFilter');
    var common = storage.getJSONItem('common');
    if (secrets && triggerFilter && common) {
      zabbix.connect(secrets.url, secrets.username, secrets.password, function() {
        var triggerWin = gui.Window.open('html/triggers.html');
        var updateTriggers = function() { 
          zabbix.retrieveTriggers(triggerFilter, function() {
            triggerWin.reload();
          });
        };
        setInterval(updateTriggers, common.updateInterval * 60000);
        updateTriggers();
      });
    } else {
      gui.Window.open('html/settings.html');
    }
    win.on('close', function() {
      if (zabbix.isConnected()) {
        zabbix.disconnect();
      }
      this.close(true);
    });
  </script>
  </body>
</html>
